<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FixIt Admin Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <!-- Aesthetic tuned to your dark gray + copper + dark violet palette -->
  <style>
    :root{
      --baseLo:#1A1C22;        /* charcoal */
      --baseHi:#262A32;        /* slightly lighter panel */
      --violetTop:#361C56;     /* dark violet highlight */
      --copper:#EC9C42;        /* copper accent */
      --ink:#E8EAF0;
      --muted:#B6BBC6;
      --ring:rgba(236,156,66,0.35);
      --card: rgba(38,42,50,0.72); /* glass */
    }
    html,body{margin:0;padding:0;background:var(--baseLo);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    a{color:var(--copper);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{
      position:sticky;top:0;z-index:50;
      backdrop-filter:saturate(120%) blur(8px);
      background:linear-gradient(180deg, rgba(26,28,34,.85), rgba(26,28,34,.55));
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .brand{display:flex;align-items:center;gap:10px;padding:14px 20px}
    .dot{width:14px;height:14px;border-radius:10px;background:var(--copper);box-shadow:0 0 18px var(--ring);}
    .kicker{font-size:11px;color:var(--muted);margin-top:-4px}
    nav.tabs{display:flex;gap:8px;padding:0 20px 14px 20px;flex-wrap:wrap}
    .tab{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:8px 12px;border-radius:12px;font-weight:600;letter-spacing:.2px;cursor:pointer}
    .tab.active{background:rgba(255,255,255,.15)}
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{background:var(--copper);color:#111;border:0;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 0 18px var(--ring);transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.alt{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
    .grid{display:grid;gap:12px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .g-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    @media (max-width:900px){.g-3,.g-4,.g-5{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
      box-shadow:0 0 24px var(--ring), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .card h3{margin:0 0 8px 0}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .input, .select{
      width:100%;padding:10px 12px;border-radius:12px;outline:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25); color:var(--ink)
    }
    .input:focus,.select:focus{border-color:var(--copper); box-shadow:0 0 0 3px rgba(236,156,66,.15)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:#D6DBE6;text-align:left}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .status{display:inline-flex;gap:8px}
    .dot-s{width:10px;height:10px;border-radius:50%}
    .green{background:#22c55e}.yellow{background:#fbbf24}.red{background:#ef4444}
    .danger{background:#ef4444;color:white}
    .warn{color:#f59e0b}
    .center{display:flex;align-items:center;justify-content:center;min-height:40vh;text-align:center}
    .blocked{max-width:560px}
    .tag{display:inline-flex;padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:12px}
    .spacer{height:8px}
    .fade-in{animation:fade .25s ease}
    @keyframes fade{from{opacity:.2;transform:translateY(2px)}to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div style="font-weight:800;letter-spacing:.3px">FixIt Admin Console</div>
        <div class="kicker">Role-based management · glass cards · copper accents</div>
      </div>
      <div style="margin-left:auto" id="userBadge" class="pill">checking auth…</div>
    </div>
    <nav class="tabs">
      <button class="tab active" data-tab="orgs">Organizations</button>
      <button class="tab" data-tab="stations">Stations</button>
      <button class="tab" data-tab="equipment">Equipment</button>
      <button class="tab" data-tab="users">Users</button>
    </nav>
  </header>

  <div class="wrap">
    <!-- Access gate -->
    <div id="gate" class="center" style="display:none">
      <div class="blocked card">
        <h2 style="margin:0 0 6px 0">Access restricted</h2>
        <div class="hint">You are signed in, but your account does not have admin privileges. Ask a global/org/regional/station admin to grant access.</div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn alt" id="signOutBtn">Sign out</button>
          <span class="hint">Required claim: <span class="tag">admin = true</span> or <span class="tag">role ∈ {station_admin, regional_admin, org_admin, global_admin}</span></span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <section id="tab-orgs" class="fade-in">
      <div class="card">
        <h3>Organizations</h3>
        <div class="grid g-3">
          <input id="org-name" class="input" placeholder="Name">
          <input id="org-code" class="input" placeholder="Code">
          <button id="org-add" class="btn">Add Organization</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div class="row"><h3 class="grow">All Organizations</h3><button id="org-refresh" class="btn alt">Refresh</button></div>
        <div class="spacer"></div>
        <div class="hint">Editing is inline; click <b>Save</b> per row.</div>
        <div class="spacer"></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Code</th><th>Actions</th></tr></thead>
            <tbody id="org-rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="tab-stations" class="fade-in" style="display:none">
      <div class="card">
        <h3>Stations</h3>
        <div class="grid g-4">
          <input id="st-orgId" class="input" placeholder="orgId">
          <input id="st-name" class="input" placeholder="Name">
          <input id="st-code" class="input" placeholder="Code (e.g., BNA)">
          <button id="st-add" class="btn">Add Station</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div class="row"><h3 class="grow">All Stations</h3><button id="st-refresh" class="btn alt">Refresh</button></div>
        <div class="spacer"></div>
        <table>
          <thead><tr><th>Org</th><th>Name</th><th>Code</th><th>Actions</th></tr></thead>
          <tbody id="st-rows"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-equipment" class="fade-in" style="display:none">
      <div class="card">
        <h3>Equipment</h3>
        <div class="grid g-5">
          <input id="eq-stationId" class="input" placeholder="stationId">
          <input id="eq-id" class="input" placeholder="equipmentId">
          <input id="eq-type" class="input" placeholder="type (e.g., TCS, Hydrant cart)">
          <select id="eq-status" class="select">
            <option value="green">green</option>
            <option value="yellow">yellow</option>
            <option value="red">red</option>
          </select>
          <button id="eq-add" class="btn">Add Equipment</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div class="row"><h3 class="grow">All Equipment</h3><button id="eq-refresh" class="btn alt">Refresh</button></div>
        <div class="spacer"></div>
        <table>
          <thead><tr><th>Station</th><th>ID</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="eq-rows"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-users" class="fade-in" style="display:none">
      <div class="card">
        <h3>Users</h3>
        <div class="hint" id="users-warning" style="display:none">
          <span class="warn">⚠</span> Callable Functions not detected. Deploy <code>admin_createUser / admin_updateUser / admin_deleteUser / admin_listUsers</code> or update the function names below.
        </div>
        <div class="spacer"></div>
        <div class="grid g-5">
          <input id="u-email" class="input" placeholder="email">
          <input id="u-pass" class="input" placeholder="password (≥6)">
          <input id="u-name" class="input" placeholder="displayName">
          <select id="u-role" class="select">
            <option>user</option><option>technician</option><option>station_admin</option>
            <option>regional_admin</option><option>org_admin</option><option>global_admin</option>
          </select>
          <input id="u-scope" class="input" placeholder='scope JSON (e.g., {"orgId":"primeflight","stationId":"BNA"})'>
        </div>
        <div class="spacer"></div>
        <button id="u-create" class="btn">Create User</button>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div class="row"><h3 class="grow">All Users</h3><button id="u-refresh" class="btn alt">Refresh</button></div>
        <div class="spacer"></div>
        <table>
          <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody id="u-rows"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ======= CONFIG =======
    const FUNCTIONS_REGION = 'us-central1'; // change if needed

    // ======= UTIL =======
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...kids) => {
      const n = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==='class') n.className=v; else if(k==='style') n.style.cssText=v; else n.setAttribute(k,v);
      }
      for(const kid of kids){ n.append(kid); }
      return n;
    };
    const fmt = v => v==null?'':String(v);

    // ======= TABS =======
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        t.classList.add('active');
        const name = t.dataset.tab;
        for(const sec of document.querySelectorAll('section[id^="tab-"]')){
          sec.style.display = (sec.id === 'tab-'+name) ? '' : 'none';
        }
      });
    });

    // ======= AUTH GATE =======
    const badge = $('#userBadge');
    const gate = $('#gate');
    const signOutBtn = $('#signOutBtn');

    function setBadge(text){ badge.textContent = text; }

    function isAdminClaims(claims){
      if(!claims) return false;
      if (claims.admin === true) return true;
      const role = claims.role;
      return ['station_admin','regional_admin','org_admin','global_admin'].includes(role);
    }

    function parseJwtClaims(idToken){
      try{
        const payload = JSON.parse(atob(idToken.split('.')[1]));
        return payload||{};
      }catch{return {}}
    }

    function requireFirebase(){
      if(!window.firebase || !firebase.apps?.length){
        throw new Error('Firebase not loaded/initialized on this page. Ensure your existing scripts run before admin.html.');
      }
    }

    // ======= BOOT =======
    let db, fx, auth;
    let call = {};
    let callablesOk = false;

    async function boot(){
      try{
        requireFirebase();
        auth = firebase.auth();
        db = firebase.firestore();
        fx = firebase.app().functions(FUNCTIONS_REGION);

        // Callable function handles
        call.createUser = fx.httpsCallable('admin_createUser');
        call.updateUser = fx.httpsCallable('admin_updateUser');
        call.deleteUser = fx.httpsCallable('admin_deleteUser');
        call.listUsers  = fx.httpsCallable('admin_listUsers');

        // Probe callable presence quickly (won’t throw if not deployed until invoked, so we’ll lazy-detect)
        callablesOk = true;
      }catch(e){
        console.error(e);
        setBadge('Firebase missing');
        alert('Firebase not loaded. Make sure your existing site includes and initializes Firebase before this file.');
        return;
      }

      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          setBadge('Not signed in');
          gate.style.display = '';
          $('#tab-orgs').style.display = 'none';
          $('#tab-stations').style.display = 'none';
          $('#tab-equipment').style.display = 'none';
          $('#tab-users').style.display = 'none';
          return;
        }
        setBadge(user.email || 'Signed in');

        const token = await user.getIdToken(true);
        const claims = parseJwtClaims(token);

        if(!isAdminClaims(claims)){
          gate.style.display = '';
          $('#tab-orgs').style.display = 'none';
          $('#tab-stations').style.display = 'none';
          $('#tab-equipment').style.display = 'none';
          $('#tab-users').style.display = 'none';
          return;
        }
        gate.style.display = 'none';

        // init tabs content
        bindOrgs();
        bindStations();
        bindEquipment();
        bindUsers();
      });

      signOutBtn.addEventListener('click', ()=>auth.signOut());
    }

    // ======= ORGS =======
    function bindOrgs(){
      const name = $('#org-name'), code = $('#org-code');
      const add = $('#org-add'), rows = $('#org-rows'), refresh = $('#org-refresh');

      async function load(){
        const snap = await db.collection('organizations').orderBy('name').get();
        rows.innerHTML = '';
        snap.forEach(doc=>{
          const o = { id:doc.id, ...doc.data() };
          const tr = el('tr', {}, 
            el('td', {}, el('input',{class:'input', value:fmt(o.name)})),
            el('td', {}, el('input',{class:'input', value:fmt(o.code)})),
            el('td', {},
              el('div',{class:'row'},
                el('button',{class:'btn alt', onclick:async ()=>{
                  const nv = tr.children[0].querySelector('input').value.trim();
                  const cv = tr.children[1].querySelector('input').value.trim();
                  await db.collection('organizations').doc(o.id).set({name:nv, code:cv},{merge:true});
                }}, 'Save'),
                el('button',{class:'btn danger', onclick:async ()=>{
                  if(confirm('Delete organization and its stations/equipment references?')) {
                    await db.collection('organizations').doc(o.id).delete();
                    tr.remove();
                  }
                }}, 'Delete')
              )
            )
          );
          rows.append(tr);
        });
      }
      add.onclick = async ()=>{
        const n = name.value.trim(), c = code.value.trim();
        if(!n || !c) return alert('Name and Code are required');
        await db.collection('organizations').add({ name:n, code:c, createdAt: Date.now() });
        name.value=''; code.value='';
        await load();
      };
      refresh.onclick = load;
      load();
    }

    // ======= STATIONS =======
    function bindStations(){
      const orgId = $('#st-orgId'), name = $('#st-name'), code = $('#st-code');
      const add = $('#st-add'), rows = $('#st-rows'), refresh = $('#st-refresh');

      async function load(){
        const snap = await db.collection('stations').orderBy('code').get();
        rows.innerHTML = '';
        snap.forEach(doc=>{
          const s = { id:doc.id, ...doc.data() };
          const tr = el('tr', {},
            el('td', {}, el('input',{class:'input', value:fmt(s.orgId)})),
            el('td', {}, el('input',{class:'input', value:fmt(s.name)})),
            el('td', {}, el('input',{class:'input', value:fmt(s.code)})),
            el('td', {},
              el('div',{class:'row'},
                el('button',{class:'btn alt', onclick:async ()=>{
                  const o = tr.children[0].querySelector('input').value.trim();
                  const n = tr.children[1].querySelector('input').value.trim();
                  const c = tr.children[2].querySelector('input').value.trim();
                  await db.collection('stations').doc(s.id).set({orgId:o, name:n, code:c},{merge:true});
                }}, 'Save'),
                el('button',{class:'btn danger', onclick:async ()=>{
                  if(confirm('Delete station?')) { await db.collection('stations').doc(s.id).delete(); tr.remove(); }
                }}, 'Delete')
              )
            )
          );
          rows.append(tr);
        });
      }
      add.onclick = async ()=>{
        const o = orgId.value.trim(), n = name.value.trim(), c = code.value.trim();
        if(!o || !n || !c) return alert('orgId, name, code required');
        await db.collection('stations').add({ orgId:o, name:n, code:c, createdAt: Date.now() });
        orgId.value=''; name.value=''; code.value='';
        await load();
      };
      refresh.onclick = load;
      load();
    }

    // ======= EQUIPMENT =======
    function bindEquipment(){
      const stationId = $('#eq-stationId'), eid = $('#eq-id'), typ = $('#eq-type'), status = $('#eq-status');
      const add = $('#eq-add'), rows = $('#eq-rows'), refresh = $('#eq-refresh');

      async function load(){
        const snap = await db.collection('equipment').orderBy('equipmentId').get();
        rows.innerHTML = '';
        snap.forEach(doc=>{
          const e = { id:doc.id, ...doc.data() };
          const tr = el('tr', {},
            el('td', {}, el('input',{class:'input', value:fmt(e.stationId)})),
            el('td', {}, el('input',{class:'input', value:fmt(e.equipmentId)})),
            el('td', {}, el('input',{class:'input', value:fmt(e.type)})),
            el('td', {},
              el('div',{class:'row'},
                el('select',{class:'select', value:fmt(e.status)},
                  el('option',{value:'green'},'green'),
                  el('option',{value:'yellow'},'yellow'),
                  el('option',{value:'red'},'red')
                )
              )
            ),
            el('td', {},
              el('div',{class:'row'},
                el('button',{class:'btn alt', onclick:async ()=>{
                  const s = tr.children[0].querySelector('input').value.trim();
                  const i = tr.children[1].querySelector('input').value.trim();
                  const t = tr.children[2].querySelector('input').value.trim();
                  const st = tr.children[3].querySelector('select').value;
                  await db.collection('equipment').doc(e.id).set({stationId:s, equipmentId:i, type:t, status:st},{merge:true});
                }}, 'Save'),
                el('button',{class:'btn danger', onclick:async ()=>{
                  if(confirm('Delete equipment?')) { await db.collection('equipment').doc(e.id).delete(); tr.remove(); }
                }}, 'Delete')
              )
            )
          );
          rows.append(tr);
        });
      }
      add.onclick = async ()=>{
        const s = stationId.value.trim(), i = eid.value.trim(), t = typ.value.trim(), st = status.value;
        if(!s || !i || !t) return alert('stationId, equipmentId, type required');
        await db.collection('equipment').add({ stationId:s, equipmentId:i, type:t, status:st, createdAt: Date.now() });
        stationId.value=''; eid.value=''; typ.value=''; status.value='green';
        await load();
      };
      refresh.onclick = load;
      load();
    }

    // ======= USERS (via callable functions) =======
    function bindUsers(){
      const warn = $('#users-warning');
      if(!call || !call.createUser) { warn.style.display = ''; return; }
      warn.style.display = callablesOk ? 'none' : '';

      const email = $('#u-email'), pass = $('#u-pass'), name = $('#u-name'),
            role = $('#u-role'), scope = $('#u-scope');
      const create = $('#u-create'), refresh = $('#u-refresh'), rows = $('#u-rows');

      async function load(){
        try{
          const res = await call.listUsers({ maxResults: 1000 });
          const users = (res.data && res.data.users) ? res.data.users : [];
          rows.innerHTML = '';
          for(const u of users){
            const r = (u.customClaims && (u.customClaims.role || (u.customClaims.admin ? 'admin' : 'user'))) || 'user';
            const tr = el('tr', {},
              el('td', {}, fmt(u.email)),
              el('td', {}, el('input',{class:'input', value:fmt(u.displayName||'')})),
              el('td', {}, el('select',{class:'select', value:r},
                  ...['user','technician','station_admin','regional_admin','org_admin','global_admin'].map(x=>el('option',{value:x},x))
              )),
              el('td', {},
                el('div',{class:'row'},
                  el('button',{class:'btn alt', onclick:async ()=>{
                    const dn = tr.children[1].querySelector('input').value.trim();
                    const rl = tr.children[2].querySelector('select').value;
                    // optional scope update: prompt for quick edit
                    let sc = prompt('Scope JSON (leave empty to keep)', '{}');
                    let parsed = {};
                    if(sc && sc.trim()){
                      try{ parsed = JSON.parse(sc) }catch{ alert('Invalid JSON; ignoring scope'); }
                    }
                    await call.updateUser({ uid:u.uid, displayName: dn, role: rl, scope: parsed });
                    await load();
                  }}, 'Update'),
                  el('button',{class:'btn danger', onclick:async ()=>{
                    if(confirm('Delete user '+(u.email||u.uid)+'?')){
                      await call.deleteUser({ uid:u.uid });
                      await load();
                    }
                  }}, 'Delete')
                )
              )
            );
            rows.append(tr);
          }
        }catch(e){
          console.error(e);
          warn.style.display = '';
        }
      }

      create.addEventListener('click', async ()=>{
        try{
          const data = {
            email: email.value.trim(),
            password: pass.value.trim(),
            displayName: name.value.trim(),
            role: role.value,
            scope: {}
          };
          if(scope.value.trim()){
            try{ data.scope = JSON.parse(scope.value.trim()); }catch{ return alert('Scope must be valid JSON'); }
          }
          if(!data.email || !data.password) return alert('Email and password required');
          await call.createUser(data);
          email.value=''; pass.value=''; name.value=''; role.value='user'; scope.value='';
          await load();
        }catch(e){ alert(e.message || String(e)); }
      });

      refresh.addEventListener('click', load);
      load();
    }

    // Kick off
    boot();
  </script>
</body>
</html>
