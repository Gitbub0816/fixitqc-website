<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FixIt Admin Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root{
      --baseLo:#1A1C22; --baseHi:#262A32; --violetTop:#361C56; --copper:#EC9C42;
      --ink:#E8EAF0; --muted:#B6BBC6; --ring:rgba(236,156,66,0.35); --card: rgba(38,42,50,0.72);
    }
    html,body{margin:0;padding:0;background:var(--baseLo);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--copper);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(120%) blur(8px);
      background:linear-gradient(180deg, rgba(26,28,34,.85), rgba(26,28,34,.55));border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{display:flex;align-items:center;gap:10px;padding:14px 20px}
    .dot{width:14px;height:14px;border-radius:10px;background:var(--copper);box-shadow:0 0 18px var(--ring)}
    .kicker{font-size:11px;color:var(--muted);margin-top:-4px}
    nav.tabs{display:flex;gap:8px;padding:0 20px 14px 20px;flex-wrap:wrap}
    .tab{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:8px 12px;border-radius:12px;font-weight:600;letter-spacing:.2px;cursor:pointer}
    .tab.active{background:rgba(255,255,255,.15)}
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{background:var(--copper);color:#111;border:0;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 0 18px var(--ring);transition:transform .05s}
    .btn:active{transform:translateY(1px)} .btn.alt{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
    .grid{display:grid;gap:12px}.g-3{grid-template-columns:repeat(3,1fr)}.g-4{grid-template-columns:repeat(4,1fr)}.g-5{grid-template-columns:repeat(5,1fr)}
    @media(max-width:900px){.g-3,.g-4,.g-5{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px;box-shadow:0 0 24px var(--ring), inset 0 1px 0 rgba(255,255,255,.05)}
    .hint{font-size:12px;color:var(--muted)} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input,.select{width:100%;padding:10px 12px;border-radius:12px;outline:none;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--ink)}
    .input:focus,.select:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(236,156,66,.15)}
    table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    tbody tr:hover{background:rgba(255,255,255,.04)} .danger{background:#ef4444;color:white}
    .center{display:flex;align-items:center;justify-content:center;min-height:38vh;text-align:center}
    .statusbar{position:sticky;bottom:0;left:0;right:0;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);
      border-top:1px solid rgba(255,255,255,.08);padding:8px 14px;font-size:12px;color:#e5e7eb}
    .statusbar b{color:var(--copper)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div style="font-weight:800;letter-spacing:.3px">FixIt Admin Console</div>
        <div class="kicker">Charcoal · Copper · Dark Violet — glass cards</div>
      </div>
      <div style="margin-left:auto" id="userBadge" class="pill">checking auth…</div>
    </div>
    <nav class="tabs">
      <button class="tab active" data-tab="orgs">Organizations</button>
      <button class="tab" data-tab="stations">Stations</button>
      <button class="tab" data-tab="equipment">Equipment</button>
      <button class="tab" data-tab="users">Users</button>
    </nav>
  </header>

  <div class="wrap">
    <div id="gate" class="center" style="display:none">
      <div class="card" style="max-width:560px">
        <h2 style="margin:0 0 6px 0">Access restricted</h2>
        <div class="hint">
          You’re signed in but missing admin claims. Required: <b>admin=true</b> or role ∈
          {station_admin, regional_admin, org_admin, global_admin}.
        </div>
        <div class="row" style="margin-top:10px">
          <button id="signOutBtn" class="btn alt">Sign out</button>
        </div>
      </div>
    </div>

    <!-- Orgs -->
    <section id="tab-orgs">
      <div class="card">
        <h3>Organizations</h3>
        <div class="grid g-3">
          <input id="org-name" class="input" placeholder="Name">
          <input id="org-code" class="input" placeholder="Code">
          <button id="org-add" class="btn">Add Organization</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="card">
        <div class="row"><h3 style="margin:0" class="grow">All Organizations</h3><button id="org-refresh" class="btn alt">Refresh</button></div>
        <div style="height:8px"></div>
        <table><thead><tr><th>Name</th><th>Code</th><th>Actions</th></tr></thead><tbody id="org-rows"></tbody></table>
      </div>
    </section>

    <!-- Stations -->
    <section id="tab-stations" style="display:none">
      <div class="card">
        <h3>Stations</h3>
        <div class="grid g-4">
          <input id="st-orgId" class="input" placeholder="orgId">
          <input id="st-name" class="input" placeholder="Name">
          <input id="st-code" class="input" placeholder="Code (e.g., BNA)">
          <button id="st-add" class="btn">Add Station</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="card">
        <div class="row"><h3 style="margin:0" class="grow">All Stations</h3><button id="st-refresh" class="btn alt">Refresh</button></div>
        <div style="height:8px"></div>
        <table><thead><tr><th>Org</th><th>Name</th><th>Code</th><th>Actions</th></tr></thead><tbody id="st-rows"></tbody></table>
      </div>
    </section>

    <!-- Equipment -->
    <section id="tab-equipment" style="display:none">
      <div class="card">
        <h3>Equipment</h3>
        <div class="grid g-5">
          <input id="eq-stationId" class="input" placeholder="stationId">
          <input id="eq-id" class="input" placeholder="equipmentId">
          <input id="eq-type" class="input" placeholder="type (e.g., TCS, Hydrant cart)">
          <select id="eq-status" class="select">
            <option value="green">green</option><option value="yellow">yellow</option><option value="red">red</option>
          </select>
          <button id="eq-add" class="btn">Add Equipment</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="card">
        <div class="row"><h3 style="margin:0" class="grow">All Equipment</h3><button id="eq-refresh" class="btn alt">Refresh</button></div>
        <div style="height:8px"></div>
        <table><thead><tr><th>Station</th><th>ID</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead><tbody id="eq-rows"></tbody></table>
      </div>
    </section>

    <!-- Users (callables) -->
    <section id="tab-users" style="display:none">
      <div class="card">
        <h3>Users</h3>
        <div class="hint" id="users-warning" style="display:none">
          ⚠ Callables not available. Deploy/enable <code>admin_createUser/admin_updateUser/admin_deleteUser/admin_listUsers</code> or update names.
        </div>
        <div style="height:8px"></div>
        <div class="grid g-5">
          <input id="u-email" class="input" placeholder="email">
          <input id="u-pass" class="input" placeholder="password (≥6)">
          <input id="u-name" class="input" placeholder="displayName">
          <select id="u-role" class="select">
            <option>user</option><option>technician</option><option>station_admin</option>
            <option>regional_admin</option><option>org_admin</option><option>global_admin</option>
          </select>
          <input id="u-scope" class="input" placeholder='scope JSON (e.g., {"orgId":"primeflight","stationId":"BNA"})'>
        </div>
        <div style="height:8px"></div>
        <button id="u-create" class="btn">Create User</button>
      </div>
      <div style="height:8px"></div>
      <div class="card">
        <div class="row"><h3 style="margin:0" class="grow">All Users</h3><button id="u-refresh" class="btn alt">Refresh</button></div>
        <div style="height:8px"></div>
        <table><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead><tbody id="u-rows"></tbody></table>
      </div>
    </section>
  </div>

  <!-- Status footer with live checks -->
  <div class="statusbar" id="status">booting…</div>

  <!-- If your site ALREADY loads Firebase, leave the next constant false.
       If you want this file to load Firebase by itself, set to true and paste config. -->
  <script>
    const USE_EMBEDDED_FIREBASE = false;                 // ← flip to true if you need CDN SDKs loaded by this file
    const FUNCTIONS_REGION = 'us-central1';              // change if your callables use another region
    const EMBEDDED_FIREBASE_CONFIG = {                   // ONLY used when USE_EMBEDDED_FIREBASE === true
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
  </script>

  <!-- Conditionally load Firebase compat SDKs if not already present -->
  <script>
    (function ensureFirebase(cb){
      if(!USE_EMBEDDED_FIREBASE && window.firebase && window.firebase.apps && window.firebase.apps.length){ cb(); return; }
      if(!USE_EMBEDDED_FIREBASE){ cb(); return; } // we’ll try to use whatever the page already has

      const urls = [
        "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js",
        "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js",
        "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js",
        "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"
      ];
      let i=0;
      function loadNext(){
        if(i>=urls.length){ cb(); return; }
        const s = document.createElement('script'); s.src=urls[i++]; s.onload=loadNext; s.onerror=()=>console.error("Failed to load", s.src);
        document.head.appendChild(s);
      }
      loadNext();
    })(function(){ startAdmin(); });
  </script>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const setStatus = (msg) => statusEl.innerHTML = msg;

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        t.classList.add('active');
        const name = t.dataset.tab;
        document.querySelectorAll('section[id^="tab-"]').forEach(sec=>{
          sec.style.display = (sec.id === 'tab-'+name) ? '' : 'none';
        });
      });
    });

    async function startAdmin(){
      setStatus('checking Firebase…');

      // Initialize if we were asked to embed SDKs
      if(USE_EMBEDDED_FIREBASE){
        if(!window.firebase) return setStatus('❌ Firebase SDKs failed to load');
        if(!firebase.apps.length){
          try{ firebase.initializeApp(EMBEDDED_FIREBASE_CONFIG); }
          catch(e){ console.error(e); setStatus('❌ Firebase init error — check config'); return; }
        }
      }

      if(!(window.firebase && firebase.apps && firebase.apps.length)){
        setStatus('❌ Firebase not found — either enable embedded SDKs or load your own before admin.html');
        return;
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      let fx;
      try { fx = firebase.app().functions(FUNCTIONS_REGION); }
      catch(e){ console.warn('Functions not available for region', FUNCTIONS_REGION); }

      const badge = $('#userBadge');
      const gate = $('#gate');
      $('#signOutBtn').addEventListener('click', ()=>auth.signOut());

      const isAdminClaims = (claims) => {
        if(!claims) return false;
        if (claims.admin === true) return true;
        return ['station_admin','regional_admin','org_admin','global_admin'].includes(claims.role);
      };
      const parseClaims = (idToken) => { try{ return JSON.parse(atob(idToken.split('.')[1]))||{} }catch{ return {} } };

      // ===== Bind data UIs =====
      function el(tag, attrs={}, ...kids){ const n=document.createElement(tag);
        for(const [k,v] of Object.entries(attrs)){ if(k==='class') n.className=v; else if(k==='onclick') n.onclick=v; else n.setAttribute(k,v); }
        kids.forEach(k=>n.append(k)); return n; }

      // Orgs
      const orgName=$('#org-name'), orgCode=$('#org-code'), orgAdd=$('#org-add'), orgRows=$('#org-rows'), orgRefresh=$('#org-refresh');
      async function loadOrgs(){
        const snap = await db.collection('organizations').orderBy('name').get();
        orgRows.innerHTML=''; snap.forEach(doc=>{
          const o={id:doc.id, ...doc.data()};
          const tr=el('tr',{},
            el('td',{}, el('input',{class:'input', value:o.name||''})),
            el('td',{}, el('input',{class:'input', value:o.code||''})),
            el('td',{},
              el('button',{class:'btn alt', onclick:async()=>{
                const nv=tr.children[0].querySelector('input').value.trim();
                const cv=tr.children[1].querySelector('input').value.trim();
                await db.collection('organizations').doc(o.id).set({name:nv, code:cv},{merge:true});
              }},'Save'),
              ' ',
              el('button',{class:'btn danger', onclick:async()=>{
                if(confirm('Delete organization?')){ await db.collection('organizations').doc(o.id).delete(); tr.remove(); }
              }},'Delete')
            )
          ); orgRows.append(tr);
        });
      }
      orgAdd.onclick = async ()=>{
        const n=orgName.value.trim(), c=orgCode.value.trim();
        if(!n||!c) return alert('Name and Code are required');
        await db.collection('organizations').add({ name:n, code:c, createdAt: Date.now() });
        orgName.value=''; orgCode.value=''; loadOrgs();
      };
      orgRefresh.onclick = loadOrgs;

      // Stations
      const stOrg=$('#st-orgId'), stName=$('#st-name'), stCode=$('#st-code'), stAdd=$('#st-add'), stRows=$('#st-rows'), stRefresh=$('#st-refresh');
      async function loadStations(){
        const snap = await db.collection('stations').orderBy('code').get();
        stRows.innerHTML=''; snap.forEach(doc=>{
          const s={id:doc.id, ...doc.data()};
          const tr=el('tr',{},
            el('td',{}, el('input',{class:'input', value:s.orgId||''})),
            el('td',{}, el('input',{class:'input', value:s.name||''})),
            el('td',{}, el('input',{class:'input', value:s.code||''})),
            el('td',{},
              el('button',{class:'btn alt', onclick:async()=>{
                const o=tr.children[0].querySelector('input').value.trim();
                const n=tr.children[1].querySelector('input').value.trim();
                const c=tr.children[2].querySelector('input').value.trim();
                await db.collection('stations').doc(s.id).set({orgId:o,name:n,code:c},{merge:true});
              }},'Save'),
              ' ',
              el('button',{class:'btn danger', onclick:async()=>{
                if(confirm('Delete station?')){ await db.collection('stations').doc(s.id).delete(); tr.remove(); }
              }},'Delete')
            )
          ); stRows.append(tr);
        });
      }
      stAdd.onclick = async ()=>{
        const o=stOrg.value.trim(), n=stName.value.trim(), c=stCode.value.trim();
        if(!o||!n||!c) return alert('orgId, name, code required');
        await db.collection('stations').add({ orgId:o, name:n, code:c, createdAt: Date.now() });
        stOrg.value=''; stName.value=''; stCode.value=''; loadStations();
      };
      stRefresh.onclick = loadStations;

      // Equipment
      const eqSt=$('#eq-stationId'), eqId=$('#eq-id'), eqType=$('#eq-type'), eqStatus=$('#eq-status'), eqAdd=$('#eq-add'), eqRows=$('#eq-rows'), eqRefresh=$('#eq-refresh');
      async function loadEquipment(){
        const snap = await db.collection('equipment').orderBy('equipmentId').get();
        eqRows.innerHTML=''; snap.forEach(doc=>{
          const e={id:doc.id, ...doc.data()};
          const tr=el('tr',{},
            el('td',{}, el('input',{class:'input', value:e.stationId||''})),
            el('td',{}, el('input',{class:'input', value:e.equipmentId||''})),
            el('td',{}, el('input',{class:'input', value:e.type||''})),
            el('td',{}, (function(){ const s=el('select',{class:'select'});
              ['green','yellow','red'].forEach(v=>s.append(el('option',{value:v, ...(e.status===v?{selected:''}:{})},v)));
              return s; })()),
            el('td',{},
              el('button',{class:'btn alt', onclick:async()=>{
                const st=tr.children[0].querySelector('input').value.trim();
                const id=tr.children[1].querySelector('input').value.trim();
                const ty=tr.children[2].querySelector('input').value.trim();
                const ss=tr.children[3].querySelector('select').value;
                await db.collection('equipment').doc(e.id).set({stationId:st, equipmentId:id, type:ty, status:ss},{merge:true});
              }},'Save'),
              ' ',
              el('button',{class:'btn danger', onclick:async()=>{
                if(confirm('Delete equipment?')){ await db.collection('equipment').doc(e.id).delete(); tr.remove(); }
              }},'Delete')
            )
          ); eqRows.append(tr);
        });
      }
      eqAdd.onclick = async ()=>{
        const s=eqSt.value.trim(), i=eqId.value.trim(), t=eqType.value.trim(), st=eqStatus.value;
        if(!s||!i||!t) return alert('stationId, equipmentId, type required');
        await db.collection('equipment').add({ stationId:s, equipmentId:i, type:t, status:st, createdAt: Date.now() });
        eqSt.value=''; eqId.value=''; eqType.value=''; eqStatus.value='green'; loadEquipment();
      };
      eqRefresh.onclick = loadEquipment;

      // Users (callables)
      const warn=$('#users-warning');
      let call = {};
      try{
        call.create = fx?.httpsCallable('admin_createUser');
        call.update = fx?.httpsCallable('admin_updateUser');
        call.remove = fx?.httpsCallable('admin_deleteUser');
        call.list   = fx?.httpsCallable('admin_listUsers');
      }catch{}
      if(!call.list) warn.style.display='';

      const uEmail=$('#u-email'), uPass=$('#u-pass'), uName=$('#u-name'), uRole=$('#u-role'), uScope=$('#u-scope');
      const uCreate=$('#u-create'), uRefresh=$('#u-refresh'), uRows=$('#u-rows');

      async function loadUsers(){
        if(!call.list){ warn.style.display=''; uRows.innerHTML=''; return; }
        try{
          const res = await call.list({ maxResults: 1000 });
          const users = (res.data && res.data.users) ? res.data.users : [];
          uRows.innerHTML='';
          users.forEach(u=>{
            const currentRole = (u.customClaims && (u.customClaims.role || (u.customClaims.admin ? 'admin' : 'user'))) || 'user';
            const tr=el('tr',{},
              el('td',{}, u.email||''),
              el('td',{}, el('input',{class:'input', value:u.displayName||''})),
              el('td',{}, (function(){ const s=el('select',{class:'select'});
                ['user','technician','station_admin','regional_admin','org_admin','global_admin'].forEach(v=>s.append(el('option',{value:v, ...(currentRole===v?{selected:''}:{})},v)));
                return s; })()),
              el('td',{},
                el('button',{class:'btn alt', onclick:async()=>{
                  const dn=tr.children[1].querySelector('input').value.trim();
                  const rl=tr.children[2].querySelector('select').value;
                  let sc='{}'; try{ sc=prompt('Scope JSON (leave empty to keep)','{}')||'{}'; }catch{}
                  let parsed={}; try{ parsed=JSON.parse(sc); }catch{ alert('Invalid JSON; ignoring scope'); }
                  await call.update({ uid:u.uid, displayName:dn, role:rl, scope:parsed });
                  await loadUsers();
                }},'Update'),
                ' ',
                el('button',{class:'btn danger', onclick:async()=>{
                  if(confirm('Delete user '+(u.email||u.uid)+'?')){ await call.remove({ uid:u.uid }); await loadUsers(); }
                }},'Delete')
              )
            ); uRows.append(tr);
          });
        }catch(e){ console.error(e); warn.style.display=''; }
      }

      uCreate.addEventListener('click', async ()=>{
        if(!call.create) return alert('User callables not available');
        const data = {
          email: uEmail.value.trim(), password: uPass.value.trim(),
          displayName: uName.value.trim(), role: uRole.value, scope: {}
        };
        if(!data.email || !data.password) return alert('Email and password required');
        if(uScope.value.trim()){ try{ data.scope = JSON.parse(uScope.value.trim()); }catch{ return alert('Scope must be valid JSON'); } }
        await call.create(data);
        uEmail.value=''; uPass.value=''; uName.value=''; uRole.value='user'; uScope.value='';
        await loadUsers();
      });
      uRefresh.addEventListener('click', loadUsers);

      // Auth gate
      setStatus('waiting for auth…');
      auth.onAuthStateChanged(async (user)=>{
        if(!user){ $('#tab-orgs').style.display='none'; $('#tab-stations').style.display='none'; $('#tab-equipment').style.display='none'; $('#tab-users').style.display='none';
          $('#gate').style.display=''; setStatus('❌ Not signed in'); return; }
        $('#gate').style.display='none';
        const token = await user.getIdToken(true);
        const claims = parseClaims(token);
        $('#userBadge').textContent = user.email || 'Signed in';

        if(!isAdminClaims(claims)){
          $('#gate').style.display=''; $('#tab-orgs').style.display='none'; $('#tab-stations').style.display='none'; $('#tab-equipment').style.display='none'; $('#tab-users').style.display='none';
          setStatus('❌ Signed in, missing admin claims'); return;
        }

        // Load data
        await Promise.all([loadOrgs(), loadStations(), loadEquipment(), loadUsers()]);
        setStatus(`<b>OK</b> Auth & claims · Firestore ready ${fx ? '· Functions ready' : '· Functions unavailable'}`);
      });
    }
  </script>
</body>
</html>
